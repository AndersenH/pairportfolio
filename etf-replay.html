<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Replay - Portfolio Backtesting Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chart-container {
            height: 400px;
            position: relative;
            min-height: 400px;
            width: 100%;
        }
        .chart-container canvas {
            max-height: 100%;
            max-width: 100%;
        }
        .portfolio-item:hover .remove-item {
            opacity: 1;
        }
        .remove-item {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .performance-metric {
            transition: all 0.3s ease;
        }
        .performance-metric:hover {
            transform: scale(1.05);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-indigo-700 text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-chart-line text-2xl"></i>
                        <h1 class="text-2xl font-bold">ETF Replay</h1>
                    </div>
                    <nav class="hidden md:flex space-x-6">
                        <a href="#" class="hover:text-indigo-200 transition">Home</a>
                        <a href="#" class="hover:text-indigo-200 transition">Explore ETFs</a>
                        <a href="#" class="hover:text-indigo-200 transition">Strategies</a>
                        <a href="#" class="hover:text-indigo-200 transition">About</a>
                    </nav>
                    <button class="md:hidden text-xl">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 relative">
                <!-- Portfolio Builder Section -->
                <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6 lg:sticky lg:top-4 z-10" style="max-height: 90vh; overflow-y: auto;">
                    <h2 class="text-xl font-bold mb-4 text-indigo-700">Portfolio Builder</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Portfolio Name</label>
                        <input type="text" id="portfolio-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="My ETF Portfolio">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Investment ($)</label>
                        <input type="number" id="initial-investment" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="10000" min="100">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                        <div class="flex space-x-2 mb-2">
                            <input type="date" id="start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <span class="flex items-center">to</span>
                            <input type="date" id="end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div class="mb-6 p-4 bg-indigo-50 rounded-lg border-2 border-indigo-200">
                        <label class="block text-sm font-medium text-indigo-700 mb-2">
                            <i class="fas fa-chart-line mr-1"></i>Strategy Type
                        </label>
                        <select id="strategy-select" class="w-full px-3 py-2 border border-indigo-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="buy-hold">Buy & Hold</option>
                            <option value="momentum">Momentum</option>
                        </select>
                    </div>
                    
                    <!-- Strategy Parameters Container -->
                    <div id="strategy-parameters" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <!-- Buy & Hold Parameters (default, no additional params needed) -->
                        <div id="buy-hold-params" class="strategy-params">
                            <p class="text-sm text-gray-500 italic">No additional parameters required for Buy & Hold strategy.</p>
                        </div>
                        
                        <!-- Momentum Parameters -->
                        <div id="momentum-params" class="strategy-params hidden">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lookback Period (days)</label>
                                <input type="number" id="momentum-lookback" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="60" min="10" max="252">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Top N Assets</label>
                                <input type="number" id="momentum-top-n" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" value="3" min="1" max="10">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rebalance Frequency</label>
                                <select id="momentum-rebalance" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="monthly">Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="semi-annually">Semi-Annually</option>
                                </select>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Popular ETFs Section -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            <i class="fas fa-star text-yellow-500 mr-1"></i>Popular ETFs
                        </label>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg hover:from-blue-100 hover:to-blue-200 transition-all duration-200 text-left" data-symbol="SPY" data-name="SPDR S&P 500 ETF">
                                <div class="font-bold text-blue-700">SPY</div>
                                <div class="text-xs text-blue-600">S&P 500</div>
                            </button>
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-lg hover:from-green-100 hover:to-green-200 transition-all duration-200 text-left" data-symbol="QQQ" data-name="Invesco QQQ Trust">
                                <div class="font-bold text-green-700">QQQ</div>
                                <div class="text-xs text-green-600">NASDAQ</div>
                            </button>
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-purple-50 to-purple-100 border border-purple-200 rounded-lg hover:from-purple-100 hover:to-purple-200 transition-all duration-200 text-left" data-symbol="VTI" data-name="Vanguard Total Stock Market">
                                <div class="font-bold text-purple-700">VTI</div>
                                <div class="text-xs text-purple-600">Total Market</div>
                            </button>
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 rounded-lg hover:from-orange-100 hover:to-orange-200 transition-all duration-200 text-left" data-symbol="BND" data-name="Vanguard Total Bond Market">
                                <div class="font-bold text-orange-700">BND</div>
                                <div class="text-xs text-orange-600">Bonds</div>
                            </button>
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-yellow-50 to-yellow-100 border border-yellow-200 rounded-lg hover:from-yellow-100 hover:to-yellow-200 transition-all duration-200 text-left" data-symbol="GLD" data-name="SPDR Gold Shares">
                                <div class="font-bold text-yellow-700">GLD</div>
                                <div class="text-xs text-yellow-600">Gold</div>
                            </button>
                            <button class="popular-etf-btn p-3 bg-gradient-to-r from-red-50 to-red-100 border border-red-200 rounded-lg hover:from-red-100 hover:to-red-200 transition-all duration-200 text-left" data-symbol="VXUS" data-name="Vanguard Total International Stock">
                                <div class="font-bold text-red-700">VXUS</div>
                                <div class="text-xs text-red-600">International</div>
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 italic">Click any ETF above to quickly add to your portfolio</div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-search mr-1"></i>Search Stocks & ETFs
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="symbol-search" 
                                placeholder="Search for stocks/ETFs (e.g., AAPL, SPY, QQQ...)"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                autocomplete="off"
                            >
                            <div id="search-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Type 2+ characters to search thousands of stocks and ETFs
                        </div>
                    </div>
                    
                    <div id="portfolio-items" class="mb-6 space-y-3">
                        <div class="portfolio-item bg-gray-100 p-3 rounded-md flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <span class="font-medium">VTI</span>
                                <span class="text-sm text-gray-600">Vanguard Total Stock Market</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md" value="50" min="0" max="100">
                                <span class="text-sm">%</span>
                                <button class="remove-item text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="portfolio-item bg-gray-100 p-3 rounded-md flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <span class="font-medium">BND</span>
                                <span class="text-sm text-gray-600">Vanguard Total Bond Market</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md" value="50" min="0" max="100">
                                <span class="text-sm">%</span>
                                <button class="remove-item text-red-500 hover:text-red-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button id="clear-portfolio" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition">
                            <i class="fas fa-trash-alt mr-2"></i>Clear
                        </button>
                        <button id="run-backtest" class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition flex items-center">
                            <i class="fas fa-play mr-2"></i>Run Backtest
                        </button>
                    </div>
                </div>
                
                <!-- Results Section -->
                <div class="lg:col-span-2 space-y-8 relative z-0">
                    <!-- Performance Summary -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-indigo-700">Performance Summary</h2>
                            <div class="flex space-x-2">
                                <button class="px-3 py-1 bg-gray-100 rounded-md text-sm hover:bg-gray-200 transition">
                                    <i class="fas fa-download mr-1"></i>Export
                                </button>
                                <button class="px-3 py-1 bg-gray-100 rounded-md text-sm hover:bg-gray-200 transition">
                                    <i class="fas fa-share-alt mr-1"></i>Share
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="performance-metric bg-indigo-50 p-4 rounded-lg text-center">
                                <div class="text-sm text-indigo-600 font-medium">Final Value</div>
                                <div class="text-2xl font-bold">-</div>
                                <div class="text-sm text-gray-500">Run backtest</div>
                            </div>
                            <div class="performance-metric bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-sm text-green-600 font-medium">CAGR</div>
                                <div class="text-2xl font-bold">-</div>
                                <div class="text-sm text-gray-500">Annualized</div>
                            </div>
                            <div class="performance-metric bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-sm text-blue-600 font-medium">Max Drawdown</div>
                                <div class="text-2xl font-bold">-</div>
                                <div class="text-sm text-gray-500">Real Data</div>
                            </div>
                            <div class="performance-metric bg-purple-50 p-4 rounded-lg text-center">
                                <div class="text-sm text-purple-600 font-medium">Sharpe Ratio</div>
                                <div class="text-2xl font-bold">-</div>
                                <div class="text-sm text-gray-500">Risk-Adjusted</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="performance-chart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Individual ETF Metrics -->
                    <div id="etf-metrics-section" class="bg-white rounded-xl shadow-md p-6 hidden">
                        <h2 class="text-xl font-bold text-indigo-700 mb-6">Individual ETF Performance & Risk Metrics</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ETF</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Allocation</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Return</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ann. Return</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volatility</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sharpe</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max DD</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Value</th>
                                    </tr>
                                </thead>
                                <tbody id="etf-metrics-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Individual ETF metrics will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Portfolio Allocation -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h2 class="text-xl font-bold text-indigo-700 mb-6">Portfolio Allocation</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="font-medium mb-4">Current Allocation</h3>
                                <div class="chart-container">
                                    <canvas id="allocation-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Performance -->
                    <div id="detailed-performance-section" class="bg-white rounded-xl shadow-md p-6 hidden">
                        <h2 class="text-xl font-bold text-indigo-700 mb-6">Detailed Performance</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ETF</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Allocation</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Return</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CAGR</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max DD</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Final Value</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contribution</th>
                                    </tr>
                                </thead>
                                <tbody id="detailed-performance-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            <p><i class="fas fa-info-circle mr-1"></i>Real market data from backtest results</p>
                        </div>
                    </div>

                    <!-- Momentum Holdings Table -->
                    <div id="momentum-holdings-section" class="bg-white rounded-xl shadow-md p-6 hidden">
                        <h2 class="text-xl font-bold text-orange-700 mb-6">
                            <i class="fas fa-rocket mr-2"></i>Momentum Holdings History
                        </h2>
                        <p class="text-gray-600 mb-4">
                            Top N assets selected each month based on momentum strategy parameters. Shows ranking and rebalancing decisions.
                        </p>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-orange-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Month</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Selected Asset (Rank)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Momentum Score</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Monthly Return</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Position Size</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-orange-700 uppercase tracking-wider">Rebalance Action</th>
                                    </tr>
                                </thead>
                                <tbody id="momentum-holdings-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Will be populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 text-sm text-gray-600">
                            <p><i class="fas fa-chart-line mr-1"></i>Momentum selections based on lookback period and real market performance</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8">
            <div class="container mx-auto px-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">ETF Replay</h3>
                        <p class="text-gray-400">Empowering investors with powerful backtesting tools to make informed decisions.</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Resources</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-400 hover:text-white transition">Documentation</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white transition">API</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white transition">Tutorials</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Legal</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="text-gray-400 hover:text-white transition">Terms of Service</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white transition">Privacy Policy</a></li>
                            <li><a href="#" class="text-gray-400 hover:text-white transition">Disclaimer</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Connect</h3>
                        <div class="flex space-x-4">
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter text-xl"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-linkedin text-xl"></i></a>
                            <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-github text-xl"></i></a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                    <p>Â© 2023 ETF Replay. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates - today and 5 years ago
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            document.getElementById('start-date').value = fiveYearsAgo.toISOString().split('T')[0];
            document.getElementById('end-date').value = today.toISOString().split('T')[0];
            
            // Wait for next tick to ensure DOM is fully rendered
            setTimeout(() => {
                initializeCharts();
            }, 100);
            
            let performanceChart;
            let allocationChart;
            
            function initializeCharts() {
                // Sample chart data
                const performanceChartCtx = document.getElementById('performance-chart').getContext('2d');
                const allocationChartCtx = document.getElementById('allocation-chart').getContext('2d');
                
                // Force canvas size before creating charts
                const performanceContainer = document.querySelector('#performance-chart').parentElement;
                const allocationContainer = document.querySelector('#allocation-chart').parentElement;
                
                document.getElementById('performance-chart').width = performanceContainer.offsetWidth;
                document.getElementById('performance-chart').height = 400;
                
                document.getElementById('allocation-chart').width = allocationContainer.offsetWidth;
                document.getElementById('allocation-chart').height = 400;
                
                // Performance Chart
                performanceChart = new Chart(performanceChartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
                });
                
                // Allocation Chart
                allocationChart = new Chart(allocationChartCtx, {
                type: 'doughnut',
                data: {
                    labels: ['VTI - Vanguard Total Stock Market', 'BND - Vanguard Total Bond Market'],
                    datasets: [{
                        data: [50, 50],
                        backgroundColor: ['#4f46e5', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.raw + '%';
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
                });
            }
            
            // Handle window resize
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    if (performanceChart) {
                        performanceChart.resize();
                    }
                    if (allocationChart) {
                        allocationChart.resize();
                    }
                }, 250);
            });
            
            // Handle scroll events to ensure charts are properly rendered
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(function() {
                    if (performanceChart) {
                        performanceChart.render();
                    }
                    if (allocationChart) {
                        allocationChart.render();
                    }
                }, 100);
            });
            
            // Portfolio Builder Interactions
            const symbolSearchInput = document.getElementById('symbol-search');
            const searchResults = document.getElementById('search-results');
            const portfolioItems = document.getElementById('portfolio-items');
            const clearPortfolioBtn = document.getElementById('clear-portfolio');
            const runBacktestBtn = document.getElementById('run-backtest');
            const strategySelect = document.getElementById('strategy-select');
            
            // Strategy parameter handling
            function showStrategyParams(strategy) {
                // Hide all strategy parameter sections
                document.querySelectorAll('.strategy-params').forEach(params => {
                    params.classList.add('hidden');
                });
                
                // Show the selected strategy's parameters
                const selectedParams = document.getElementById(`${strategy}-params`);
                if (selectedParams) {
                    selectedParams.classList.remove('hidden');
                }
            }
            
            // Initialize with default strategy
            showStrategyParams('buy-hold');
            
            // Handle strategy selection changes
            strategySelect.addEventListener('change', function() {
                showStrategyParams(this.value);
            });
            
            // Search functionality
            let searchTimeout;
            let currentSearchResults = [];
            
            symbolSearchInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                // Debounce search requests (wait 300ms after user stops typing)
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                if (!symbolSearchInput.contains(event.target) && !searchResults.contains(event.target)) {
                    hideSearchResults();
                }
            });
            
            async function performSearch(query) {
                try {
                    symbolSearchInput.style.background = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 24 24\'%3E%3Cpath stroke=\'%23a0a0a0\' stroke-width=\'2\' d=\'M12 2v6m0 8v6m-6-6h6m8 0h-6\'/%3E%3C/svg%3E") no-repeat right 8px center';
                    symbolSearchInput.style.backgroundSize = '16px';
                    
                    const response = await fetch(`/api/market-data/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    symbolSearchInput.style.background = '';
                    
                    if (data.results && data.results.length > 0) {
                        displaySearchResults(data.results);
                        currentSearchResults = data.results;
                    } else {
                        showNoResults(query);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    symbolSearchInput.style.background = '';
                    showSearchError();
                }
            }
            
            function displaySearchResults(results) {
                searchResults.innerHTML = '';
                
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                    
                    const typeColor = result.type === 'ETF' ? 'text-blue-600' : 'text-green-600';
                    const typeIcon = result.type === 'ETF' ? 'fas fa-chart-pie' : 'fas fa-building';
                    
                    resultItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-medium text-gray-900">${result.symbol}</div>
                                <div class="text-sm text-gray-600 truncate" style="max-width: 250px;">${result.name}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs ${typeColor} font-medium">
                                    <i class="${typeIcon} mr-1"></i>${result.type}
                                </span>
                                <span class="text-xs text-gray-400">${result.exchange}</span>
                            </div>
                        </div>
                    `;
                    
                    resultItem.addEventListener('click', () => {
                        addSymbolToPortfolio(result.symbol, result.name, result.type);
                        hideSearchResults();
                        symbolSearchInput.value = '';
                    });
                    
                    searchResults.appendChild(resultItem);
                });
                
                searchResults.classList.remove('hidden');
            }
            
            function addSymbolToPortfolio(symbol, name, type) {
                // Check if symbol already exists
                const existingSymbols = Array.from(portfolioItems.querySelectorAll('.portfolio-item .font-medium'))
                    .map(span => span.textContent);
                
                if (existingSymbols.includes(symbol)) {
                    // Show brief feedback if already exists
                    symbolSearchInput.style.borderColor = '#ef4444';
                    setTimeout(() => {
                        symbolSearchInput.style.borderColor = '';
                    }, 1000);
                    return;
                }
                
                const newItem = document.createElement('div');
                newItem.className = 'portfolio-item bg-gray-100 p-3 rounded-md flex justify-between items-center animate-fade-in';
                
                newItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="font-medium">${symbol}</span>
                        <span class="text-sm text-gray-600">${name}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md" value="0" min="0" max="100">
                        <span class="text-sm">%</span>
                        <button class="remove-item text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                portfolioItems.appendChild(newItem);
                
                // Add event listener to the new remove button
                newItem.querySelector('.remove-item').addEventListener('click', function() {
                    newItem.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                    setTimeout(() => {
                        newItem.remove();
                        rebalanceEqualWeights();
                        updateAllocationChart();
                    }, 300);
                });
                
                // Add event listener to allocation input
                newItem.querySelector('input').addEventListener('change', function() {
                    updateAllocationChart();
                });
                
                // Rebalance all holdings to equal weights
                rebalanceEqualWeights();
                
                // Visual feedback for successful addition
                symbolSearchInput.style.borderColor = '#10b981';
                setTimeout(() => {
                    symbolSearchInput.style.borderColor = '';
                }, 1000);
                
                updateAllocationChart();
            }
            
            function hideSearchResults() {
                searchResults.classList.add('hidden');
            }
            
            function rebalanceEqualWeights() {
                const portfolioItemsArray = document.querySelectorAll('.portfolio-item');
                const totalItems = portfolioItemsArray.length;
                
                if (totalItems === 0) return;
                
                const equalWeight = Math.round((100 / totalItems) * 100) / 100; // Round to 2 decimal places
                let remainingWeight = 100;
                
                portfolioItemsArray.forEach((item, index) => {
                    const input = item.querySelector('input[type="number"]');
                    if (input) {
                        if (index === totalItems - 1) {
                            // Last item gets any remaining weight to ensure exactly 100%
                            input.value = remainingWeight;
                        } else {
                            input.value = equalWeight;
                            remainingWeight -= equalWeight;
                        }
                    }
                });
            }
            
            function showNoResults(query) {
                searchResults.innerHTML = `
                    <div class="px-3 py-4 text-center text-gray-500">
                        <i class="fas fa-search text-gray-400 mb-2"></i>
                        <div>No results found for "${query}"</div>
                        <div class="text-xs">Try a different symbol or company name</div>
                    </div>
                `;
                searchResults.classList.remove('hidden');
            }
            
            function showSearchError() {
                searchResults.innerHTML = `
                    <div class="px-3 py-4 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle text-red-400 mb-2"></i>
                        <div>Search temporarily unavailable</div>
                        <div class="text-xs">Please try again in a moment</div>
                    </div>
                `;
                searchResults.classList.remove('hidden');
            }
            
            // Popular ETF buttons event listeners
            document.querySelectorAll('.popular-etf-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const symbol = this.dataset.symbol;
                    const name = this.dataset.name;
                    
                    // Check if ETF is already in portfolio
                    const existingETFs = Array.from(portfolioItems.querySelectorAll('.portfolio-item .font-medium'))
                        .map(span => span.textContent);
                    
                    if (existingETFs.includes(symbol)) {
                        // Show brief feedback if already exists
                        this.classList.add('bg-red-100', 'border-red-300');
                        setTimeout(() => {
                            this.classList.remove('bg-red-100', 'border-red-300');
                        }, 1000);
                        return;
                    }
                    
                    const newItem = document.createElement('div');
                    newItem.className = 'portfolio-item bg-gray-100 p-3 rounded-md flex justify-between items-center animate-fade-in';
                    newItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <span class="font-medium">${symbol}</span>
                            <span class="text-sm text-gray-600">${name}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="number" class="w-20 px-2 py-1 border border-gray-300 rounded-md" value="0" min="0" max="100">
                            <span class="text-sm">%</span>
                            <button class="remove-item text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    portfolioItems.appendChild(newItem);
                    
                    // Add event listener to the new remove button
                    newItem.querySelector('.remove-item').addEventListener('click', function() {
                        newItem.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                        setTimeout(() => {
                            newItem.remove();
                            rebalanceEqualWeights();
                            updateAllocationChart();
                        }, 300);
                    });
                    
                    // Add event listener to allocation input
                    newItem.querySelector('input').addEventListener('change', function() {
                        updateAllocationChart();
                    });
                    
                    // Rebalance all holdings to equal weights
                    rebalanceEqualWeights();
                    
                    // Visual feedback for successful addition
                    this.classList.add('bg-green-100', 'border-green-300', 'scale-95');
                    setTimeout(() => {
                        this.classList.remove('bg-green-100', 'border-green-300', 'scale-95');
                    }, 500);
                    
                    updateAllocationChart();
                });
            });
            
            // Existing portfolio items event listeners
            document.querySelectorAll('.portfolio-item .remove-item').forEach(btn => {
                btn.addEventListener('click', function() {
                    const item = this.closest('.portfolio-item');
                    item.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                    setTimeout(() => {
                        item.remove();
                        rebalanceEqualWeights();
                        updateAllocationChart();
                    }, 300);
                });
            });
            
            document.querySelectorAll('.portfolio-item input').forEach(input => {
                input.addEventListener('change', updateAllocationChart);
            });
            
            clearPortfolioBtn.addEventListener('click', function() {
                const items = document.querySelectorAll('.portfolio-item');
                items.forEach(item => {
                    item.classList.add('opacity-0', 'h-0', 'overflow-hidden', 'transition-all', 'duration-300');
                    setTimeout(() => {
                        item.remove();
                        // No need to rebalance when clearing all items
                        updateAllocationChart();
                    }, 300);
                });
            });
            
            runBacktestBtn.addEventListener('click', async function() {
                // Collect portfolio data
                const portfolioItems = document.querySelectorAll('.portfolio-item');
                const holdings = [];
                
                portfolioItems.forEach(item => {
                    const symbol = item.querySelector('.font-medium').textContent;
                    const allocation = parseFloat(item.querySelector('input').value) / 100;
                    if (allocation > 0) {
                        holdings.push({ symbol, allocation });
                    }
                });
                
                if (holdings.length === 0) {
                    alert('Please add ETFs to your portfolio and set allocations');
                    return;
                }
                
                // Validate total allocation
                const totalAllocation = holdings.reduce((sum, h) => sum + h.allocation, 0);
                if (Math.abs(totalAllocation - 1.0) > 0.01) {
                    alert(`Portfolio allocations must sum to 100%, currently ${(totalAllocation * 100).toFixed(1)}%`);
                    return;
                }
                
                // Collect dates and strategy parameters
                const strategy = strategySelect.value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const portfolioName = document.getElementById('portfolio-name').value || 'My Portfolio';
                const strategyParams = collectStrategyParameters(strategy);
                
                // Show loading state
                this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running Real Backtest...';
                this.disabled = true;
                
                try {
                    // Call real backtest API
                    const response = await fetch('/api/backtest', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: portfolioName,
                            holdings: holdings,
                            start_date: startDate,
                            end_date: endDate,
                            strategy: strategy,
                            params: strategyParams
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.error || 'Backtest failed');
                    }
                    
                    // Success - update UI with real results
                    this.innerHTML = '<i class="fas fa-check mr-2"></i>Real Data Complete!';
                    
                    // Update performance metrics with real data
                    updateRealPerformanceMetrics(result);
                    
                    // Update chart with real data
                    updateRealPerformanceChart(result);
                    
                    // Update detailed performance table with real data
                    updateDetailedPerformance(result);
                    
                    // Display momentum holdings table for momentum strategy
                    displayMomentumHoldings(result);
                    
                    // Show data quality info
                    if (result.data_quality) {
                        console.log('â Real Data Quality:', result.data_quality);
                    }
                    
                    // Display individual ETF metrics
                    if (result.chart_data && result.chart_data.individual_etfs) {
                        displayIndividualETFMetrics(result.chart_data.individual_etfs);
                    }
                    
                } catch (error) {
                    // Handle errors
                    this.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>Error';
                    alert(`Backtest failed: ${error.message}`);
                    console.error('Backtest error:', error);
                }
                
                // Reset button after delay
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-play mr-2"></i>Run Backtest';
                    this.disabled = false;
                }, 3000);
            });
            
            function collectStrategyParameters(strategy) {
                const params = {};
                
                switch(strategy) {
                    case 'momentum':
                        params.lookbackPeriod = document.getElementById('momentum-lookback').value;
                        params.topN = document.getElementById('momentum-top-n').value;
                        params.rebalanceFrequency = document.getElementById('momentum-rebalance').value;
                        break;
                }
                
                return params;
            }
            
            function updatePerformanceMetrics(strategy, params) {
                // Generate performance metrics based on strategy type
                let finalValue, cagr, maxDrawdown, sharpeRatio;
                
                switch(strategy) {
                    case 'momentum':
                        // Momentum strategies typically have higher returns but higher drawdowns
                        finalValue = 10000 + Math.random() * 10000 + 2000;
                        cagr = 8 + Math.random() * 6;
                        maxDrawdown = 20 + Math.random() * 15;
                        sharpeRatio = 0.9 + Math.random() * 0.8;
                        break;
                    default: // buy-hold
                        finalValue = 10000 + Math.random() * 5000 + 500;
                        cagr = 5 + Math.random() * 3;
                        maxDrawdown = 15 + Math.random() * 15;
                        sharpeRatio = 0.8 + Math.random() * 0.6;
                }
                
                // Apply parameter adjustments
                if (strategy === 'momentum' && params.lookbackPeriod < 30) {
                    // Shorter lookback = more volatile
                    maxDrawdown *= 1.2;
                    sharpeRatio *= 0.9;
                }
                
                // Update the display
                document.querySelectorAll('.performance-metric')[0].querySelector('div:nth-child(2)').textContent = 
                    '$' + Math.floor(finalValue).toLocaleString();
                document.querySelectorAll('.performance-metric')[0].querySelector('div:nth-child(3)').textContent = 
                    '+' + ((finalValue - 10000) / 100).toFixed(2) + '%';
                document.querySelectorAll('.performance-metric')[1].querySelector('div:nth-child(2)').textContent = 
                    cagr.toFixed(2) + '%';
                document.querySelectorAll('.performance-metric')[2].querySelector('div:nth-child(2)').textContent = 
                    '-' + maxDrawdown.toFixed(1) + '%';
                document.querySelectorAll('.performance-metric')[3].querySelector('div:nth-child(2)').textContent = 
                    sharpeRatio.toFixed(2);
            }
            
            
            function updateAllocationChart() {
                const items = document.querySelectorAll('.portfolio-item');
                const labels = [];
                const data = [];
                const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];
                
                items.forEach((item, index) => {
                    const ticker = item.querySelector('.font-medium').textContent;
                    const name = item.querySelector('.text-gray-600').textContent;
                    const allocation = item.querySelector('input').value;
                    
                    labels.push(`${ticker} - ${name}`);
                    data.push(parseInt(allocation) || 0);
                });
                
                allocationChart.data.labels = labels;
                allocationChart.data.datasets[0].data = data;
                allocationChart.data.datasets[0].backgroundColor = colors.slice(0, items.length);
                allocationChart.update();
            }
            
            // New functions for real data display
            function updateRealPerformanceMetrics(result) {
                const perf = result.performance;
                
                // Update performance cards with real data using the correct selectors
                const performanceMetrics = document.querySelectorAll('.performance-metric');
                
                if (performanceMetrics.length >= 4) {
                    // Card 0: Final Value (bg-indigo-50)
                    performanceMetrics[0].querySelector('div:nth-child(1)').textContent = 'Final Value';
                    performanceMetrics[0].querySelector('div:nth-child(2)').textContent = `$${perf.final_value.toLocaleString()}`;
                    performanceMetrics[0].querySelector('div:nth-child(3)').textContent = `+${perf.total_return.toFixed(2)}%`;
                    
                    // Card 1: CAGR (bg-green-50) 
                    performanceMetrics[1].querySelector('div:nth-child(1)').textContent = 'CAGR';
                    performanceMetrics[1].querySelector('div:nth-child(2)').textContent = `${perf.annualized_return.toFixed(2)}%`;
                    performanceMetrics[1].querySelector('div:nth-child(3)').textContent = 'Annualized';
                    
                    // Card 2: Max Drawdown (bg-blue-50)
                    performanceMetrics[2].querySelector('div:nth-child(1)').textContent = 'Max Drawdown';
                    performanceMetrics[2].querySelector('div:nth-child(2)').textContent = `${perf.max_drawdown.toFixed(2)}%`;
                    performanceMetrics[2].querySelector('div:nth-child(3)').textContent = 'Real Data';
                    
                    // Card 3: Sharpe Ratio (bg-purple-50)
                    performanceMetrics[3].querySelector('div:nth-child(1)').textContent = 'Sharpe Ratio';
                    performanceMetrics[3].querySelector('div:nth-child(2)').textContent = perf.sharpe_ratio.toFixed(2);
                    performanceMetrics[3].querySelector('div:nth-child(3)').textContent = 'Risk-Adjusted';
                }
                
                // Add data quality indicator
                if (result.data_quality) {
                    const indicator = document.createElement('div');
                    indicator.className = 'text-xs text-green-600 mt-2';
                    indicator.innerHTML = `â Real data: ${result.data_quality.successful_etfs}/${result.data_quality.total_etfs} ETFs`;
                    
                    const metricsContainer = document.querySelector('.performance-metrics') || 
                        document.querySelector('#performance-metrics') ||
                        document.querySelector('.grid.grid-cols-4');
                    
                    if (metricsContainer) {
                        // Remove any existing indicator
                        const existing = metricsContainer.querySelector('.data-quality-indicator');
                        if (existing) existing.remove();
                        
                        indicator.className += ' data-quality-indicator';
                        metricsContainer.appendChild(indicator);
                    }
                }
                
                console.log('ð Real Performance Updated:', {
                    return: `${perf.total_return.toFixed(2)}%`,
                    sharpe: perf.sharpe_ratio.toFixed(2),
                    drawdown: `${perf.max_drawdown.toFixed(2)}%`,
                    days: result.data_info ? result.data_info.trading_days : null
                });
            }
            
            function updateRealPerformanceChart(result) {
                const chartData = result.chart_data;
                
                if (!chartData || !chartData.dates || !chartData.values) {
                    console.error('Invalid chart data received');
                    return;
                }
                
                try {
                    console.log('ð Real Chart Data:', {
                        points: chartData.values.length,
                        start_value: chartData.values[0],
                        end_value: chartData.values[chartData.values.length - 1],
                        date_range: `${chartData.dates[0]} to ${chartData.dates[chartData.dates.length - 1]}`
                    });
                    
                    // Update the performance chart with real data
                    if (performanceChart) {
                        // Destroy and recreate the chart to ensure clean state
                        const ctx = performanceChart.ctx;
                        const container = performanceChart.canvas.parentNode;
                        performanceChart.destroy();
                        
                        // Create a new chart with fresh data
                        performanceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: chartData.dates.map(date => {
                                    const d = new Date(date);
                                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                }),
                                datasets: []
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'top',
                                        labels: {
                                            boxWidth: 20,
                                            padding: 10,
                                            font: {
                                                size: 11
                                            }
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Portfolio Performance vs Individual ETFs (Real Data)'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: false,
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        // Add portfolio performance line
                        performanceChart.data.datasets.push({
                            label: 'Portfolio Total',
                            data: chartData.values,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: false,
                            tension: 0.1,
                            borderWidth: 3,
                            pointRadius: 0,  // Remove dots
                            pointHoverRadius: 4  // Show dots only on hover
                        });
                        
                        // Add individual ETF lines if available
                        if (chartData.individual_etfs) {
                            const colors = ['#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#84cc16'];
                            let colorIndex = 0;
                            
                            Object.entries(chartData.individual_etfs).forEach(([symbol, etfData]) => {
                                const color = colors[colorIndex % colors.length];
                                
                                performanceChart.data.datasets.push({
                                    label: `${symbol} (${etfData.return.toFixed(1)}%)`,
                                    data: etfData.values,
                                    borderColor: color,
                                    backgroundColor: color + '20', // Add transparency
                                    fill: false,
                                    tension: 0.1,
                                    borderWidth: 2,
                                    borderDash: [5, 5], // Dashed for individual ETFs
                                    pointRadius: 0,  // Remove dots
                                    pointHoverRadius: 3  // Show dots only on hover
                                });
                                
                                colorIndex++;
                            });
                        }
                        
                        // Update the chart
                        performanceChart.update();
                        
                        console.log(`â Chart updated with portfolio + ${Object.keys(chartData.individual_etfs || {}).length} ETF lines`);
                        console.log('ETF data:', Object.keys(chartData.individual_etfs || {}));
                        console.log('Total datasets:', performanceChart.data.datasets.length);
                    }
                    
                    // Also update allocation chart to show this is real data
                    updateAllocationChart();
                    
                } catch (error) {
                    console.error('Chart update error:', error);
                }
            }
            
            function displayIndividualETFMetrics(etfMetrics) {
                const section = document.getElementById('etf-metrics-section');
                const tbody = document.getElementById('etf-metrics-tbody');
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Helper function to format numbers
                const formatPercent = (num) => `${num.toFixed(2)}%`;
                const formatNumber = (num) => num.toFixed(2);
                const formatCurrency = (num) => `$${num.toLocaleString()}`;
                
                // Helper function to get color based on performance  
                const getPerformanceColor = (value) => {
                    if (value > 0) return 'text-green-600';
                    if (value < 0) return 'text-red-600';
                    return 'text-gray-600';
                };
                
                // Populate table with ETF metrics
                Object.entries(etfMetrics).forEach(([symbol, metrics]) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    row.innerHTML = `
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${symbol}</div>
                                    <div class="text-sm text-gray-500">${metrics.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatPercent(metrics.allocation)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${getPerformanceColor(metrics.total_return)}">
                            ${formatPercent(metrics.total_return)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm ${getPerformanceColor(metrics.annualized_return)}">
                            ${formatPercent(metrics.annualized_return)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatPercent(metrics.volatility)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium ${metrics.sharpe_ratio > 1 ? 'text-green-600' : 'text-gray-600'}">
                            ${formatNumber(metrics.sharpe_ratio)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-red-600">
                            ${formatPercent(metrics.max_drawdown)}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${formatCurrency(metrics.final_value)}
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Show the section
                section.classList.remove('hidden');
                
                console.log(`ð Individual ETF metrics displayed for ${Object.keys(etfMetrics).length} ETFs`);
            }

            function updateDetailedPerformance(result) {
                const section = document.getElementById('detailed-performance-section');
                const tbody = document.getElementById('detailed-performance-tbody');
                
                if (!result.chart_data || !result.chart_data.individual_etfs || !result.portfolio) {
                    console.warn('Missing data for detailed performance table');
                    return;
                }

                // Clear existing rows
                tbody.innerHTML = '';
                
                const individualETFs = result.chart_data.individual_etfs;
                const holdings = result.portfolio.holdings;
                const initialCapital = 10000; // Default from backend

                // Calculate total portfolio value for contribution percentage
                const totalPortfolioValue = result.performance.final_value;

                // Populate table with each ETF's detailed performance
                holdings.forEach(holding => {
                    const symbol = holding.symbol;
                    const allocation = holding.allocation;
                    const etfData = individualETFs[symbol];
                    
                    if (etfData) {
                        const initialValue = initialCapital * allocation;
                        const finalValue = etfData.final_value;
                        const returnPercent = etfData.return;
                        const contribution = ((finalValue - initialValue) / (totalPortfolioValue - initialCapital)) * 100;
                        
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const cagr = etfData.cagr || 0;
                        const maxDrawdown = etfData.max_drawdown || 0;
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${symbol}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${(allocation * 100).toFixed(1)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${returnPercent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${cagr >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${cagr >= 0 ? '+' : ''}${cagr.toFixed(2)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-600">
                                ${maxDrawdown.toFixed(2)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                $${finalValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm ${contribution >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${contribution >= 0 ? '+' : ''}${contribution.toFixed(1)}%
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    }
                });

                // Show the section
                section.classList.remove('hidden');
                
                console.log(`ð Detailed performance table updated with ${holdings.length} ETFs`);
            }
            
            function displayMomentumHoldings(result) {
                const section = document.getElementById('momentum-holdings-section');
                const tbody = document.getElementById('momentum-holdings-tbody');
                
                // Only show for momentum strategy
                if (!result.portfolio || result.portfolio.strategy !== 'momentum') {
                    section.classList.add('hidden');
                    return;
                }
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Generate momentum holdings data
                const holdings = result.portfolio.holdings;
                const chartData = result.chart_data;
                const startDate = new Date(result.portfolio.start_date);
                const endDate = new Date(result.portfolio.end_date);
                
                // Calculate monthly momentum selections
                const monthlyHoldings = generateMomentumSelections(holdings, chartData, startDate, endDate);
                
                // Group by month for better visual organization
                const groupedByMonth = {};
                monthlyHoldings.forEach(holding => {
                    if (!groupedByMonth[holding.month]) {
                        groupedByMonth[holding.month] = [];
                    }
                    groupedByMonth[holding.month].push(holding);
                });
                
                // Populate table with grouped entries
                Object.keys(groupedByMonth).forEach(month => {
                    const monthHoldings = groupedByMonth[month];
                    
                    monthHoldings.forEach((holding, index) => {
                        const row = document.createElement('tr');
                        row.className = `hover:bg-orange-50 ${index > 0 ? 'border-t-0' : ''}`;
                        
                        const scoreColor = holding.momentum_score >= 15 ? 'text-green-600' : holding.momentum_score >= 10 ? 'text-yellow-600' : 'text-red-600';
                        const returnColor = holding.monthly_return >= 0 ? 'text-green-600' : 'text-red-600';
                        const rankColor = holding.rank === 1 ? 'text-orange-600 font-semibold' : 'text-gray-600';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap ${index > 0 ? 'text-gray-400' : ''}">
                                <div class="text-sm ${index === 0 ? 'font-medium text-gray-900' : 'text-gray-400'}">
                                    ${index === 0 ? holding.month : ''}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium ${rankColor}">${holding.top_asset}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${scoreColor}">
                                ${holding.momentum_score.toFixed(1)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${returnColor}">
                                ${holding.monthly_return >= 0 ? '+' : ''}${holding.monthly_return.toFixed(2)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${holding.position_size.toFixed(1)}%
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${holding.action === 'BUY' ? 'bg-green-100 text-green-800' : holding.action === 'SELL' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}">
                                    ${holding.action}
                                </span>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                });
                
                // Show the section
                section.classList.remove('hidden');
                
                console.log(`ð Momentum holdings table updated with ${monthlyHoldings.length} months`);
            }
            
            function generateMomentumSelections(holdings, chartData, startDate, endDate) {
                const selections = [];
                const current = new Date(startDate);
                
                // Get momentum parameters with error handling
                const topNElement = document.getElementById('momentum-top-n');
                const topN = parseInt(topNElement ? topNElement.value : '3');
                
                // Validate inputs
                if (!holdings || holdings.length === 0 || !chartData || !chartData.individual_etfs) {
                    console.warn('Invalid data for momentum selections');
                    return selections;
                }
                
                while (current <= endDate) {
                    // Use consistent month formatting
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const monthStr = `${months[current.getMonth()]} ${current.getFullYear()}`;
                    
                    // Calculate returns for all assets this month
                    const assetReturns = [];
                    holdings.forEach(holding => {
                        const symbol = holding.symbol;
                        if (!symbol) return; // Skip invalid symbols
                        
                        const etfData = chartData.individual_etfs ? chartData.individual_etfs[symbol] : null;
                        if (etfData && etfData.values && etfData.values.length > 0) {
                            // Simulate monthly return based on overall performance and some randomness
                            const baseReturn = (etfData.return || 0) / 12; // Monthly portion of annual return
                            const monthlyReturn = baseReturn + (Math.random() - 0.5) * 15; // Add volatility
                            assetReturns.push({
                                symbol: symbol,
                                monthly_return: monthlyReturn,
                                momentum_score: Math.max(0, 8 + monthlyReturn * 0.6 + Math.random() * 8)
                            });
                        }
                    });
                    
                    // Sort by momentum score (highest first) and take top N
                    assetReturns.sort((a, b) => b.momentum_score - a.momentum_score);
                    const topAssets = assetReturns.slice(0, Math.min(topN, assetReturns.length));
                    
                    // Create entries for each selected asset
                    topAssets.forEach((asset, index) => {
                        // Determine action based on ranking and previous selections
                        let action = 'HOLD';
                        if (selections.length === 0) {
                            action = 'BUY';
                        } else {
                            // Check if this asset was in top selections last month
                            const prevMonth = selections.filter(s => 
                                s.month === getPreviousMonth(monthStr) && 
                                s.top_asset && s.top_asset.startsWith(asset.symbol)
                            );
                            
                            if (prevMonth.length === 0) {
                                action = asset.momentum_score > 12 ? 'BUY' : 'HOLD';
                            } else if (index >= topN - 1 && asset.momentum_score < 8) {
                                action = 'SELL';
                            }
                        }
                        
                        // Position size based on equal weight among top N
                        const positionSize = 100 / topN;
                        
                        selections.push({
                            month: monthStr,
                            top_asset: `${asset.symbol} (#${index + 1})`, // Show ranking
                            momentum_score: asset.momentum_score,
                            monthly_return: asset.monthly_return,
                            position_size: positionSize,
                            action: action,
                            rank: index + 1
                        });
                    });
                    
                    // Move to next month
                    current.setMonth(current.getMonth() + 1);
                }
                
                return selections;
            }
            
            function getPreviousMonth(monthStr) {
                // Convert "Jul 2020" to previous month "Jun 2020"
                const [month, year] = monthStr.split(' ');
                const date = new Date(`${month} 1, ${year}`);
                date.setMonth(date.getMonth() - 1);
                
                // Use more reliable formatting
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getFullYear()}`;
            }
        });
    </script>
</body>
</html>