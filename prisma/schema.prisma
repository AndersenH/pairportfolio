// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?   // Added for credential authentication
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts   Account[]
  sessions   Session[]
  portfolios Portfolio[]
  backtests  Backtest[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Portfolio {
  id          String   @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean  @default(false)
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  holdings  PortfolioHolding[]
  backtests Backtest[]

  @@index([userId])
}

model PortfolioHolding {
  id          String  @id @default(cuid())
  portfolioId String
  symbol      String
  allocation  Float
  name        String?

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([symbol])
}

model Strategy {
  id          String  @id @default(cuid())
  name        String  @unique
  type        String
  description String
  isSystem    Boolean @default(false)
  parameters  Json?

  backtests Backtest[]

  @@index([type])
  @@index([isSystem])
}

model Backtest {
  id                   String   @id @default(cuid())
  portfolioId          String
  strategyId           String
  name                 String?
  startDate            DateTime
  endDate              DateTime
  initialCapital       Float    @default(10000)
  benchmarkSymbol      String?
  rebalancingFrequency String   @default("monthly")
  parameters           Json?
  status               String   @default("pending")
  progress             Int?     @default(0)
  results              Json?
  errorMessage         String?
  startedAt            DateTime?
  completedAt          DateTime?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  userId               String

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  strategy  Strategy  @relation(fields: [strategyId], references: [id])
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics   PerformanceMetrics?

  @@index([portfolioId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([benchmarkSymbol])
}

model PerformanceMetrics {
  id                    String @id @default(cuid())
  backtestId            String @unique
  totalReturn           Float
  annualizedReturn      Float
  volatility            Float
  sharpeRatio           Float?
  maxDrawdown           Float
  maxDrawdownDuration   Int?
  alpha                 Float?
  beta                  Float?
  calmarRatio           Float?
  sortinoRatio          Float?
  var95                 Float?
  cvar95                Float?
  winRate               Float?
  profitFactor          Float?

  backtest Backtest @relation(fields: [backtestId], references: [id], onDelete: Cascade)
}

model MarketData {
  id       String   @id @default(cuid())
  symbol   String
  date     DateTime
  open     Float
  high     Float
  low      Float
  close    Float
  volume   BigInt?
  adjClose Float?

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

model ETFInfo {
  id          String  @id @default(cuid())
  symbol      String  @unique
  name        String
  description String?
  expenseRatio Float?
  aum         Float?
  inception   DateTime?
  category    String?
  updatedAt   DateTime @updatedAt

  @@index([symbol])
  @@index([category])
}