generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String      @id @default(cuid())
  name          String?
  email         String      @unique
  emailVerified DateTime?
  password      String?
  image         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  accounts      Account[]
  backtests     Backtest[]
  portfolios    Portfolio[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Portfolio {
  id          String             @id @default(cuid())
  name        String
  description String?
  isPublic    Boolean            @default(false)
  userId      String
  templateId  String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  backtests   Backtest[]
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  template    LazyPortfolioTemplate? @relation(fields: [templateId], references: [id])
  holdings    PortfolioHolding[]

  @@index([userId])
  @@index([templateId])
}

model PortfolioHolding {
  id          String    @id @default(cuid())
  portfolioId String
  symbol      String
  allocation  Float
  name        String?
  portfolio   Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@unique([portfolioId, symbol])
  @@index([portfolioId])
  @@index([symbol])
}

model BacktestHolding {
  id         String   @id @default(cuid())
  backtestId String
  symbol     String
  allocation Float
  name       String?
  backtest   Backtest @relation(fields: [backtestId], references: [id], onDelete: Cascade)

  @@unique([backtestId, symbol])
  @@index([backtestId])
  @@index([symbol])
}

model Strategy {
  id          String     @id @default(cuid())
  name        String     @unique
  type        String
  description String
  isSystem    Boolean    @default(false)
  parameters  Json?
  backtests   Backtest[]

  @@index([type])
  @@index([isSystem])
}

model Backtest {
  id                   String              @id @default(cuid())
  portfolioId          String
  strategyId           String
  name                 String?
  startDate            DateTime
  endDate              DateTime
  initialCapital       Float               @default(10000)
  benchmarkSymbol      String?
  rebalancingFrequency String              @default("monthly")
  parameters           Json?
  status               String              @default("pending")
  progress             Int?                @default(0)
  results              Json?
  errorMessage         String?
  startedAt            DateTime?
  completedAt          DateTime?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  userId               String
  portfolio            Portfolio           @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  strategy             Strategy            @relation(fields: [strategyId], references: [id])
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics              PerformanceMetrics?
  holdings             BacktestHolding[]

  @@index([portfolioId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([benchmarkSymbol])
}

model PerformanceMetrics {
  id                  String   @id @default(cuid())
  backtestId          String   @unique
  totalReturn         Float
  annualizedReturn    Float
  volatility          Float
  sharpeRatio         Float?
  maxDrawdown         Float
  maxDrawdownDuration Int?
  alpha               Float?
  beta                Float?
  calmarRatio         Float?
  sortinoRatio        Float?
  var95               Float?
  cvar95              Float?
  winRate             Float?
  profitFactor        Float?
  backtest            Backtest @relation(fields: [backtestId], references: [id], onDelete: Cascade)
}

model MarketData {
  id       String   @id @default(cuid())
  symbol   String
  date     DateTime
  open     Float
  high     Float
  low      Float
  close    Float
  volume   BigInt?
  adjClose Float?

  @@unique([symbol, date])
  @@index([symbol])
  @@index([date])
}

model ETFInfo {
  id           String    @id @default(cuid())
  symbol       String    @unique
  name         String
  description  String?
  expenseRatio Float?
  aum          Float?
  inception    DateTime?
  category     String?
  updatedAt    DateTime  @updatedAt

  @@index([symbol])
  @@index([category])
}

model LazyPortfolioTemplate {
  id              String                   @id @default(cuid())
  name            String                   @unique
  description     String?
  creator         String?
  category        String?
  riskLevel       String?
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  holdings        LazyPortfolioHolding[]
  metrics         LazyPortfolioMetrics?
  portfolios      Portfolio[]

  @@index([category])
  @@index([riskLevel])
  @@index([isActive])
}

model LazyPortfolioHolding {
  id         String                @id @default(cuid())
  templateId String
  symbol     String
  allocation Float
  name       String?
  assetClass String?
  template   LazyPortfolioTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, symbol])
  @@index([templateId])
  @@index([symbol])
  @@index([assetClass])
}

model LazyPortfolioMetrics {
  id                  String                @id @default(cuid())
  templateId          String                @unique
  totalReturn         Float?
  annualizedReturn    Float?
  volatility          Float?
  sharpeRatio         Float?
  maxDrawdown         Float?
  calmarRatio         Float?
  sortinoRatio        Float?
  beta                Float?
  alpha               Float?
  backtestStartDate   DateTime?
  backtestEndDate     DateTime?
  calculatedAt        DateTime              @default(now())
  template            LazyPortfolioTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
}
